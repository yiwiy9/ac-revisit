# Implementation Plan

- [ ] 1. 実行基盤と起動ガードを確立する
- [x] 1.1 AtCoder・ログイン状態を判定して起動可否を制御する
  - URL と DOM から `isSupported` と `isLoggedIn` を判定し、未ログイン時は UI と提案処理を起動しない。
  - AtCoder 以外のページは早期 return し、復習機能が一切動作しないことを保証する。
  - 起動時にページ種別を正規化して後続コントローラの分岐条件を統一する。
  - _Requirements: 1.1, 9.3_
- [x] 1.2 GM Storage の永続化層と状態スキーマを実装する
  - 復習対象、現在提案、日次状態、メタ情報をキー分離して保存・取得できるようにする。
  - 読み取り失敗時は既定値へフォールバックし、処理継続可能な状態を返す。
  - `schemaVersion` と `needsIntegrityRepair` を含むメタ状態を管理する。
  - _Requirements: 1.2, 5.1, 5.4_
- [x] 1.3 配布・実行制約を満たすユーザースクリプト設定を整える
  - `@match` を AtCoder ドメインに限定し、Tampermonkey 前提で実行できる設定を行う。
  - `@grant` を最小構成で定義し、外部 API/外部サーバー通信を実装しない方針を固定する。
  - Greasy Fork 配布を前提にメタデータを整合させる。
  - _Requirements: 1.3, 9.1, 9.2_

- [ ] 2. 復習対象の登録・解除導線を実装する
- [ ] 2.1 (P) 問題ページで登録トグルを表示して操作可能にする
  - 問題 ID を抽出し、登録状態に応じてトグル表示を切り替える。
  - 未登録時は登録処理を実行し、即時に UI 状態を反映する。
  - _Requirements: 2.1, 2.3_
- [ ] 2.2 (P) 提出詳細ページで登録トグルを表示して操作可能にする
  - 提出詳細ページのコンテキストから問題 ID を特定してトグルを描画する。
  - 登録済み状態を正しく表示し、ページ再訪問時も状態が維持されるようにする。
  - _Requirements: 2.2, 2.3_
- [ ] 2.3 登録解除時の削除連携を実装する
  - トグル解除時は復習対象から物理削除し、現在提案が同一問題ならクリアする。
  - 削除後は自動差し替えを行わず、利用者操作まで提案空状態を維持する。
  - _Requirements: 2.4, 6.2, 6.3_

- [ ] 3. 候補選定と日次提案フローを実装する
- [ ] 3.1 14日固定ルールで候補判定・ランダム選定を実装する
  - 登録日のみ/最終完了日ありの両ケースで eligible 判定を行う。
  - 間隔最適化を導入せず、固定 14 日ルールのみで判定する。
  - 候補なしを正常系として扱い、空結果を返せるようにする。
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 8.3_
- [ ] 3.2 日次初回アクセス時に1問選定して通知を制御する
  - ローカル日付で当日初回アクセスを判定し、候補から 1 問のみ選定する。
  - 当日未通知かつ提案成立時のみリンクだけのポップアップを 1 回表示する。
  - 同日2回目以降や候補なしでは新規通知を表示しない。
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_
- [ ] 3.3 Current Suggestion の単一性と保持条件を実装する
  - 現在提案は常に 0 か 1 件に保ち、active がある場合は日次初回でも上書きしない。
  - 明示的に削除・クリアされるまで再訪時も同一提案を保持する。
  - _Requirements: 5.1, 5.4_

- [ ] 4. メニュー導線と提案操作を実装する
- [ ] 4.1 ユーザー名メニューに Current Suggestion 導線を表示する
  - 現在提案がある場合のみ遷移可能リンクを表示する。
  - 現在提案がない場合は無効遷移を生成せず安全側の表示にする。
  - _Requirements: 5.2, 5.3_
- [ ] 4.2 現在提案の完了操作を実装する
  - 完了操作時に当日を完了日として記録し、提案状態を completed へ更新する。
  - _Requirements: 6.1_
- [ ] 4.3 削除操作の整合性制御を実装する
  - 削除時は「復習対象削除成功後に current クリア」の順序を保証する。
  - 部分失敗時は `needsIntegrityRepair` を立て、次回起動時修復の対象にする。
  - _Requirements: 6.2, 6.3_
- [ ] 4.4 もう1問要求の条件分岐を実装する
  - 未完了状態では差し替え要求を拒否し、状態を変更しない。
  - 完了済み状態のみ候補から再抽選し、候補なし時は新規提案を作成しない。
  - もう1問で新規提案された場合も追加自動通知は表示しない。
  - _Requirements: 6.4, 6.5, 6.6, 6.7_

- [ ] 5. 提出詳細ページの自動AC検知を実装する
- [ ] 5.1 提出詳細ページ限定で非ブロッキング判定を実行する
  - 提出詳細ページのみ検知対象とし、提出一覧ページは対象外にする。
  - 判定処理は非同期で実行し、ページ利用をブロックしない。
  - _Requirements: 7.1, 7.3, 7.5_
- [ ] 5.2 AC条件一致時のみ自動完了を反映する
  - 現在提案の問題 ID 一致かつ当日 AC のときだけ完了記録を更新する。
  - AC 以外や判定失敗時は自動完了せず、手動完了操作を継続可能にする。
  - _Requirements: 7.2, 7.4, 7.6_

- [ ] 6. 例外時の安全動作とMVP境界を固める
- [ ] 6.1 起動時整合性修復を実装する
  - `needsIntegrityRepair` または孤立した current 提案を検知したら、復習対象との照合で修復する。
  - 修復不能時は current を安全にクリアして以降の処理を継続する。
  - _Requirements: 5.1, 5.4, 6.2, 6.3_
- [ ] 6.2 障害時の劣化運転とログ方針を実装する
  - ストレージ失敗・DOM抽出失敗・AC判定失敗時に機能単位でスキップし全停止を避ける。
  - ログカテゴリを統一し、重大整合性エラーは過剰出力を抑制する。
  - _Requirements: 1.1, 7.4_
- [ ] 6.3 MVP対象外機能を実装から除外する
  - 一覧画面、可視化、メモ、タグ、ストリーク、統計、動的間隔変更を実装しない。
  - 既存機能へ不要なUI導線を追加しないことを確認する。
  - _Requirements: 8.1, 8.2, 8.3_

- [ ] 7. 統合テストを整備して受け入れ基準を検証する
- [ ] 7.1 候補判定・日次制御・提案操作の単体テストを作成する
  - 14日閾値、日付境界、active上書き禁止、もう1問条件分岐を網羅する。
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 4.3, 4.6, 5.1, 6.4, 6.5, 6.6, 6.7_
- [ ] 7.2 (P) ページ別UI導線と通知挙動の統合テストを作成する
  - 未ログイン時非表示、問題/提出詳細トグル、メニュー導線、同日通知1回を検証する。
  - _Requirements: 1.1, 2.1, 2.2, 4.2, 4.3, 4.4, 5.2, 5.3, 9.3_
- [ ] 7.3 (P) 自動AC検知と整合性修復シナリオの統合テストを作成する
  - 提出詳細のみ検知、AC時自動完了、失敗時手動継続、削除部分失敗後の修復を検証する。
  - _Requirements: 6.2, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_
- [ ] 7.4 実行環境制約の検証を行う
  - Tampermonkey での動作、AtCoder 以外で非動作、外部通信なしを確認する。
  - _Requirements: 1.3, 9.1, 9.2, 9.3_
